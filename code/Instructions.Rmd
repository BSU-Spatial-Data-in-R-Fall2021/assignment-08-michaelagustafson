---
title: "Making static maps"
author: "Matt Williamson"
date: "10/20/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
getwd()
```


## Your assignment

The goals for this assignment are to:

- practice making maps with the various packages
- think about composition and the grammar of graphics
- critique various maps

_By the end of the assignment_ you should have several static maps displaying the datasets we've used in the last few weeks.

# Task 1: Show me your ugly maps!!
Find 2 examples of maps that you think are 'bad'. 
_Question 1_ Why are they bad? What might improve them? 
_Question 2_ Rely on the Healy and Wilke texts to provide some structure to your answers.

![Bad Map 1](/home/michaela/R/assignment-08-michaelagustafson/code/badmap1.jpg)
Why is this a bad map? Using monocolor schemes isn't always the best choice. In this example, many of the colors are very similar, therefore, its hard to tell what color is actually corresponding to some states.

Bad Map 2
![Bad Map 2](/home/michaela/R/assignment-08-michaelagustafson/code/badmap2.png)
To me, this map is a little hard to understand. The lighter colored countries say that the reported religious affiliation is less than 90%, but how much less? And if it's less than 90% then maybe it isn't even the majority of the population that is affiliated with that religion and perhaps another religion is more prevalent. 


# Task 2: Load your libraries and build a dataframe
You can choose whichever datasets you'd like from the past several months as the subject for your mapping. You'll need to use at least one tabular join, one spatial join, and one extraction to create the dataframe. Load the packages, the data, and make sure everything is projected here. Give me a sense for what you are hoping to map.

```{r loadlibrary}
library(terra)
library(sf)
library(tidyr)
library(dplyr)


data <- list.files("/opt/data/session14/")
data

# Questions: Which protected area has the most species richness? And are the
# most species rich protected areas visited the most?

pas.shp <- read_sf("/opt/data/session14/reg_pas.shp")
mamm.rich <- rast("/opt/data/session16/Mammals_total_richness.tif")
park.visits <- read.csv("/opt/data/session14/ParkVisits_2020IWPW.csv", skip = 3)

```
# Check geometries

```{r geocheck}
st_is_valid(pas.shp)
pas.shp.valid <- st_make_valid(pas.shp)
st_is_valid(pas.shp.valid)
```

# Check CRS
```{r crscheck}

st_crs(pas.shp.valid)$proj4string
st_crs(mamm.rich)

# shapefile needs to be in same CRS as raster
# DON'T REPROJECT RASTERS

pas.valid.proj <- pas.shp.valid %>% 
  st_transform(., crs = st_crs(mamm.rich))

st_crs(pas.valid.proj) == st_crs(mamm.rich)

# Also know from previous code we need to catalyze mammal richness:
# And only keep what we need: the value
mamm.rich <- catalyze(mamm.rich)
plot(mamm.rich)

# When we plot the data we see that the “Value” raster contains the informaiton we are looking for (the number of species weighted by their regional rarity). Lets take that and leave the rest.
mamm.rich <- mamm.rich[[2]]
plot(mamm.rich)
```

# Tablular Join
Join park visit data to Protected Area's shapefile data

```{r}
# keep only columns needed for protected areas and park visits

prot.areas <- pas.valid.proj %>%
  select(ParkName = Unit_Nm, State = Stat_Nm, geometry)

list(unique(park.visits$ParkType))

# now change name strings to match park visit ParkName format:
prot.areas$ParkName <- gsub("National Park", "NP", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Monument", "NM", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Battlefield", "NB", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Historical Park", "NHP", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Reserve", "NR", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Seashore", "NS", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Recreation Area", "NRA", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Historic Site", "NHS", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Preserve", "NPRES", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Memorial", "NMEM", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Parkway", "MEM PKWY", prot.areas$ParkName)
prot.areas$ParkName <- gsub("National Wild & Scenic River", "W&SR", prot.areas$ParkName)

plot(prot.areas)


# clean up park visit and make visits numeric so they can be added together
park.visits$RecreationVisits <- as.numeric(gsub(",","", park.visits$RecreationVisits))


# group by park and state
ann.park.visits <- park.visits %>% 
  group_by(UnitCode, ParkName, State) %>% 
  summarise(., Visits = sum(RecreationVisits))

# left join... and Put prot.areas on left, then park visits on right...

prot.area.visit.join <- left_join(prot.areas, ann.park.visits)
prot.area.visit.join <- prot.area.visit.join %>%
  select(ParkName, State, Visits, geometry)

head(prot.area.visit.join); dim(prot.area.visit.join)

# and we ended up with the same number of observations from the protected areas file, 544
```


# Spatial Join
*** Need to figure out how to actually include a spatial join? This step would actually be:

# Extraction?
Join protected areas shapefile with species richness. 
Only joining species richness data that lies within the protected area boundary


# Crop Mammal Richness to geometries
```{r rastcrop}
# first need to project protected area sf as a SpatVector to be able to use 'terra' functions on it:
prot.area.vect <- as(prot.area.visit.join, "SpatVector")

mamm.rich.crop <- crop(mamm.rich, project(prot.area.vect, mamm.rich))

plot(mamm.rich.crop)
plot(prot.area.vect, add = TRUE)
```

# Extract species richness value for each protected area
# going to go with max species richness??

```{r zones}

prot.area.vect.proj <- terra::project(prot.area.vect, mamm.rich)
prot.area.zones <- terra::rasterize(prot.area.vect.proj, mamm.rich.crop, field = "ParkName")
mammal.zones <- terra::zonal(mamm.rich.crop, prot.area.zones, fun = "max", na.rm=TRUE)

mammal.zones <- mammal.zones[!is.na(mammal.zones$ParkName),]

max(mammal.zones$Value) #88

which(mammal.zones == max(mammal.zones$Value), arr.ind = T)

max.mm.rich <- as.data.frame(mammal.zones$ParkName[c(1:3, 7, 10, 24, 26, 28, 32:34, 40, 51, 70, 73, 75, 85, 109, 118, 123, 125, 130, 131)])
# rename column name back to ParkName

max.mm.rich <- dplyr::rename(max.mm.rich, ParkName = "mammal.zones$ParkName[c(1:3, 7, 10, 24, 26, 28, 32:34, 40, 51, 70, 73, 75, 85, 109, 118, 123, 125, 130, 131)]")

print(max.mm.rich)


max.rich.visits <- left_join(max.mm.rich, ann.park.visits)

# There are a lot of protected areas that didn't have visitor data, so we'll take those out
max.rich.visits <- max.rich.visits[!is.na(max.rich.visits$Visits),]

# so now we have the number of visits for the most mammal species rich protected areas:
print(max.rich.visits)
# Carlsbad Caverns National Park and Mesa Verde National Park

# BUT, are these the protected areas with the HIGHEST number of visits?
# Because I'm trying to answer if the species richness is correlated with number of visits (are people visiting that place because the of the variety of mammal species in the area that they might potentially see? If not, why are those most visited areas so popular? Probably for the rocks...)

print(max(ann.park.visits$Visits))

# the protected area with the most visits had 12,400,045 visitors/year2020

# It's actually the Golden Gate National Recreation Area! Maybe because this is located right in San Francisco and is easily accessible???
```

# Task 3: Build a map with Tmap
Practice making a quick map with tmap. 

```{r tmap}

```

# Task 4: Build a choropleth with ggplot
Your map should have a basemap, should rely on more than one aesthetic (color, transparency, etc), and combine multiple layers.

# Task 5: Build 2 cartograms
Follow the examples to build cartograms that display your region of interest based on variables other than area.

_Question 3:_ Reflect on the different maps you've made, what do the different visualizations tell you about the data you plotted?

_Question 4:_ How might you improve the maps you've made?

_Question 5:_ Is a map the best way to evaluate the data you worked with? Why or Why not?


